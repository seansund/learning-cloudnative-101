{"componentChunkName":"component---src-pages-electives-dist-trace-activities-lab-4-index-mdx","path":"/electives/dist-trace/activities/lab4/","result":{"pageContext":{"frontmatter":{"title":"Using Jaeger in OpenShift/Kubernetes"},"relativePagePath":"/electives/dist-trace/activities/lab4/index.mdx","titleType":"page","MdxNode":{"id":"a798e8ea-3a18-5eb0-84a9-461fc72f7382","children":[],"parent":"d2c5802c-a231-5059-affa-d44008e615a6","internal":{"content":"---\ntitle: Using Jaeger in OpenShift/Kubernetes\n---\n\n## General Instructions\n\n1. Clone the git repository\n\n  ```\n  git clone https://github.com/ibm-cloud-architecture/learning-distributed-tracing-101.git\n  ```\n\n2. Change to the lab directory\n\n  ```\n  cd learning-distrubing-tracing-101/lab-jaeger-ocp\n  ```\n\n## Understanding Jaeger\n\n* Read the OpenShift Documentation [Understanding Jaeger](https://docs.openshift.com/container-platform/4.1/service_mesh/service_mesh_arch/ossm-jaeger.html)\n\n## Installing the Jaeger operator\n\nOpenShift 3\n  * Install from OperatorHub.io [Jaeger Operator](https://operatorhub.io/operator/jaeger)\nOpenShift 4, You can use the CodeReady Containers for local development cluster [Code Ready Containers](https://cloud.redhat.com/openshift/install/crc/installer-provisioned)\n  * [Installing the Jaeger Operator on OpenShift 4](https://docs.openshift.com/container-platform/4.1/service_mesh/service_mesh_install/installing-ossm.html#ossm-operator-install-jaeger_installing-ossm)\n\n## (OpenShift 3) Creating an instance of Jaeger\n\nCreate a Custom Resource for Jaeger\n\n1. Log in to the OpenShift Container Platform web console.\n2. Select project `operators` \n3. Verify Jaeger Operator installed\n4. From the command line, create a Jaeger instance in the `default` namespace\n\n  ```\n  kubectl apply -f - <<EOF\n  apiVersion: jaegertracing.io/v1\n  kind: Jaeger\n  metadata:\n    name: my-jaeger\n  EOF\n  ```\n\n## (OpenShift 4) Creating an instance of Jaeger\n\nCreate a Custom Resource for Jaeger\n\n1. Log in to the OpenShift Container Platform web console.\n2. Select project `openshift-operators`\n3. Navigate to **Operators â†’ Installed Operators**\n4. Click the **Jaeger Operator** provided by Red Hat\n5. Under **Provided APIs** \n6. Click **Create Instance**\n7. Edit namespace to your project for example `default`\n8. Review yaml and Click Create\n\n## Verify Jaeger instance created\n\n1. Verify the Jaeger services in the `default` namespace\n\n  ```\n  oc get services -n default | grep jaeger\n  my-jaeger-agent                ClusterIP      None             <none>      5775/UDP,5778/TCP,6831/UDP,6832/UDP      7m\n  my-jaeger-collector            ClusterIP      172.21.191.135   <none>      9411/TCP,14250/TCP,14267/TCP,14268/TCP   7m\n  my-jaeger-collector-headless   ClusterIP      None             <none>      9411/TCP,14250/TCP,14267/TCP,14268/TCP   7m\n  my-jaeger-query                ClusterIP      172.21.89.78     <none>      443/TCP                                  7m\n  ```\n\nNOTE: Take a look at the `my-jaeger-collector` on port `14268/TCP` this is the service to be used by our services to send the Jaeger traces containing the spans, you will configure this in the kubernetes deployment yaml manifest.\n\n2. Find the route to the Jaeger UI\n\n  ```\n  oc get route my-jaeger        \n  NAME        HOST/PORT                            PATH   SERVICES          PORT    TERMINATION   WILDCARD\n  my-jaeger   my-jaeger-default.apps-crc.testing          my-jaeger-query   <all>   reencrypt     None\n  ```\n\n3. Open the Jaeger UI in the browser using value HOST/PORT - https://my-jaeger-default.apps-crc.testing\n\n## Deploy the Application\n\n1. Deploy the services `service-a` and `service-b`\n\nUse the file `jaeger-nodejs.yaml` for Node.js or the file `jaeger-java.yaml` for Java\n\nHere is an example using Node.js services and deployments:\n\n  ```\n  oc apply -f jaeger-nodejs.yaml -n default\n  ```\nLet's look at the file content on how the services are defined to be deploy into OpenShift cluster:\n\n```\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: service-a\n  labels:\n    app: service-a\nspec:\n  ports:\n    - port: 8080\n      name: http\n  selector:\n    app: service-a\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: service-a\n  labels:\n    app: service-a\n    version: v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: service-a\n  template:\n    metadata:\n      labels:\n        app: service-a\n        version: v1\n    spec:\n      containers:\n        - name: app\n          image: csantanapr/service-a-nodejs\n          env:\n            - name: JAEGER_ENDPOINT\n              value: http://my-jaeger-collector:14268/api/traces\n            - name: SERVICE_FORMATTER\n              value: service-b\n          imagePullPolicy: Always\n          ports:\n            - containerPort: 8080\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: service-b\n  labels:\n    app: service-b\nspec:\n  ports:\n    - port: 8081\n      name: http\n  selector:\n    app: service-b\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: service-b\n  labels:\n    app: service-b\n    version: v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: service-b\n  template:\n    metadata:\n      labels:\n        app: service-b\n        version: v1\n    spec:\n      containers:\n        - name: app\n          image: csantanapr/service-b-nodejs\n          env:\n            - name: JAEGER_ENDPOINT\n              value: http://my-jaeger-collector:14268/api/traces\n          imagePullPolicy: Always\n          ports:\n            - containerPort: 8081\n\n```\n\nIn the yaml deployment manifest there are few items to point out:\n\n**Ports**\n  * The port for the container is specified in the service and the container in the deployment, for example `service-a` with port `8080` and `service-b` with port `8081`.\n\n**Environment Variables**\n  * The variable `JAEGER_ENDPOINT` is specified to indicate to the Jaeger client library to send the traces using http to the jaeger collector service `http://my-jaeger-collector:14268/api/traces` that is deployed on the same namespace `default` as the services. You could also opt for using a side card and use UDP to send traces to an agent side card and this will foward the traces to the jaeger collector for more info see the jaeger operator documentation on how to enable this with an annotation.  \n  * The variable `SERVICE_FORMATTER` used by `service-a` to indicate the hostname of `service-b` that will use to format the hello message.\n\n\n2. Verify services are deployed and running:\n\n  ```\n  oc get all -l app=service-a -n default\n  oc get all -l app=service-b -n default\n  NAME                             READY   STATUS    RESTARTS   AGE\n  pod/service-a-785975554d-5cql2   1/1     Running   0          19m\n  pod/service-b-674b748766-t7464   1/1     Running   0          19m\n\n  NAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\n  service/service-a   ClusterIP   172.30.182.142   <none>        8080/TCP   20m\n  service/service-b   ClusterIP   172.30.108.212   <none>        8081/TCP   19m\n\n  NAME                        READY   UP-TO-DATE   AVAILABLE   AGE\n  deployment.apps/service-a   1/1     1            1           19m\n  deployment.apps/service-b   1/1     1            1           19m\n  ```\n\n3. Expose the service `service-a` with a route\n\n  ```\n  oc create route edge  --service=service-a -n default\n  ```\n\n4. Get the hostname for the route:\n\n  ```\n  oc get route service-a -n default\n  NAME        HOST/PORT                            PATH   SERVICES    PORT   TERMINATION   WILDCARD\n  service-a   service-a-default.apps-crc.testing          service-a   http   edge          None\n  ```\n\n## Find Traces\n\n1. Use curl or open browser with the endpoint URL using the HOST/PORT of the route\n\n  ```\n  curl -k https://service-a-default.apps-crc.testing/sayHello/Carlos\n  Hello from service-b Carlos!\n  ```\n\nFrom the result you can see that `service-a` called `service-b` and replied back.\n\n2. In the Jaeger UI select service-a and click **Find Traces**\n\n![jaeger-trace](../../images/ocp-jaeger-traces.png)\n\n\n3. Click on one of the traces and expand the spans in the trace\n\n![jaeger-span](../../images/ocp-jaeger-spans.png)\n\n\nCheck one of the labs [Lab Jaeger - Node.js](./lab1) or [Lab Jaeger - Java](./lab2) for a more in depth lab for Opentracing with Jaeger.","type":"Mdx","contentDigest":"44d12151dadae17ca17a3bc6e72813f9","counter":592,"owner":"gatsby-plugin-mdx"},"exports":[],"rawBody":"---\ntitle: Using Jaeger in OpenShift/Kubernetes\n---\n\n## General Instructions\n\n1. Clone the git repository\n\n  ```\n  git clone https://github.com/ibm-cloud-architecture/learning-distributed-tracing-101.git\n  ```\n\n2. Change to the lab directory\n\n  ```\n  cd learning-distrubing-tracing-101/lab-jaeger-ocp\n  ```\n\n## Understanding Jaeger\n\n* Read the OpenShift Documentation [Understanding Jaeger](https://docs.openshift.com/container-platform/4.1/service_mesh/service_mesh_arch/ossm-jaeger.html)\n\n## Installing the Jaeger operator\n\nOpenShift 3\n  * Install from OperatorHub.io [Jaeger Operator](https://operatorhub.io/operator/jaeger)\nOpenShift 4, You can use the CodeReady Containers for local development cluster [Code Ready Containers](https://cloud.redhat.com/openshift/install/crc/installer-provisioned)\n  * [Installing the Jaeger Operator on OpenShift 4](https://docs.openshift.com/container-platform/4.1/service_mesh/service_mesh_install/installing-ossm.html#ossm-operator-install-jaeger_installing-ossm)\n\n## (OpenShift 3) Creating an instance of Jaeger\n\nCreate a Custom Resource for Jaeger\n\n1. Log in to the OpenShift Container Platform web console.\n2. Select project `operators` \n3. Verify Jaeger Operator installed\n4. From the command line, create a Jaeger instance in the `default` namespace\n\n  ```\n  kubectl apply -f - <<EOF\n  apiVersion: jaegertracing.io/v1\n  kind: Jaeger\n  metadata:\n    name: my-jaeger\n  EOF\n  ```\n\n## (OpenShift 4) Creating an instance of Jaeger\n\nCreate a Custom Resource for Jaeger\n\n1. Log in to the OpenShift Container Platform web console.\n2. Select project `openshift-operators`\n3. Navigate to **Operators â†’ Installed Operators**\n4. Click the **Jaeger Operator** provided by Red Hat\n5. Under **Provided APIs** \n6. Click **Create Instance**\n7. Edit namespace to your project for example `default`\n8. Review yaml and Click Create\n\n## Verify Jaeger instance created\n\n1. Verify the Jaeger services in the `default` namespace\n\n  ```\n  oc get services -n default | grep jaeger\n  my-jaeger-agent                ClusterIP      None             <none>      5775/UDP,5778/TCP,6831/UDP,6832/UDP      7m\n  my-jaeger-collector            ClusterIP      172.21.191.135   <none>      9411/TCP,14250/TCP,14267/TCP,14268/TCP   7m\n  my-jaeger-collector-headless   ClusterIP      None             <none>      9411/TCP,14250/TCP,14267/TCP,14268/TCP   7m\n  my-jaeger-query                ClusterIP      172.21.89.78     <none>      443/TCP                                  7m\n  ```\n\nNOTE: Take a look at the `my-jaeger-collector` on port `14268/TCP` this is the service to be used by our services to send the Jaeger traces containing the spans, you will configure this in the kubernetes deployment yaml manifest.\n\n2. Find the route to the Jaeger UI\n\n  ```\n  oc get route my-jaeger        \n  NAME        HOST/PORT                            PATH   SERVICES          PORT    TERMINATION   WILDCARD\n  my-jaeger   my-jaeger-default.apps-crc.testing          my-jaeger-query   <all>   reencrypt     None\n  ```\n\n3. Open the Jaeger UI in the browser using value HOST/PORT - https://my-jaeger-default.apps-crc.testing\n\n## Deploy the Application\n\n1. Deploy the services `service-a` and `service-b`\n\nUse the file `jaeger-nodejs.yaml` for Node.js or the file `jaeger-java.yaml` for Java\n\nHere is an example using Node.js services and deployments:\n\n  ```\n  oc apply -f jaeger-nodejs.yaml -n default\n  ```\nLet's look at the file content on how the services are defined to be deploy into OpenShift cluster:\n\n```\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: service-a\n  labels:\n    app: service-a\nspec:\n  ports:\n    - port: 8080\n      name: http\n  selector:\n    app: service-a\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: service-a\n  labels:\n    app: service-a\n    version: v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: service-a\n  template:\n    metadata:\n      labels:\n        app: service-a\n        version: v1\n    spec:\n      containers:\n        - name: app\n          image: csantanapr/service-a-nodejs\n          env:\n            - name: JAEGER_ENDPOINT\n              value: http://my-jaeger-collector:14268/api/traces\n            - name: SERVICE_FORMATTER\n              value: service-b\n          imagePullPolicy: Always\n          ports:\n            - containerPort: 8080\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: service-b\n  labels:\n    app: service-b\nspec:\n  ports:\n    - port: 8081\n      name: http\n  selector:\n    app: service-b\n---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: service-b\n  labels:\n    app: service-b\n    version: v1\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: service-b\n  template:\n    metadata:\n      labels:\n        app: service-b\n        version: v1\n    spec:\n      containers:\n        - name: app\n          image: csantanapr/service-b-nodejs\n          env:\n            - name: JAEGER_ENDPOINT\n              value: http://my-jaeger-collector:14268/api/traces\n          imagePullPolicy: Always\n          ports:\n            - containerPort: 8081\n\n```\n\nIn the yaml deployment manifest there are few items to point out:\n\n**Ports**\n  * The port for the container is specified in the service and the container in the deployment, for example `service-a` with port `8080` and `service-b` with port `8081`.\n\n**Environment Variables**\n  * The variable `JAEGER_ENDPOINT` is specified to indicate to the Jaeger client library to send the traces using http to the jaeger collector service `http://my-jaeger-collector:14268/api/traces` that is deployed on the same namespace `default` as the services. You could also opt for using a side card and use UDP to send traces to an agent side card and this will foward the traces to the jaeger collector for more info see the jaeger operator documentation on how to enable this with an annotation.  \n  * The variable `SERVICE_FORMATTER` used by `service-a` to indicate the hostname of `service-b` that will use to format the hello message.\n\n\n2. Verify services are deployed and running:\n\n  ```\n  oc get all -l app=service-a -n default\n  oc get all -l app=service-b -n default\n  NAME                             READY   STATUS    RESTARTS   AGE\n  pod/service-a-785975554d-5cql2   1/1     Running   0          19m\n  pod/service-b-674b748766-t7464   1/1     Running   0          19m\n\n  NAME                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE\n  service/service-a   ClusterIP   172.30.182.142   <none>        8080/TCP   20m\n  service/service-b   ClusterIP   172.30.108.212   <none>        8081/TCP   19m\n\n  NAME                        READY   UP-TO-DATE   AVAILABLE   AGE\n  deployment.apps/service-a   1/1     1            1           19m\n  deployment.apps/service-b   1/1     1            1           19m\n  ```\n\n3. Expose the service `service-a` with a route\n\n  ```\n  oc create route edge  --service=service-a -n default\n  ```\n\n4. Get the hostname for the route:\n\n  ```\n  oc get route service-a -n default\n  NAME        HOST/PORT                            PATH   SERVICES    PORT   TERMINATION   WILDCARD\n  service-a   service-a-default.apps-crc.testing          service-a   http   edge          None\n  ```\n\n## Find Traces\n\n1. Use curl or open browser with the endpoint URL using the HOST/PORT of the route\n\n  ```\n  curl -k https://service-a-default.apps-crc.testing/sayHello/Carlos\n  Hello from service-b Carlos!\n  ```\n\nFrom the result you can see that `service-a` called `service-b` and replied back.\n\n2. In the Jaeger UI select service-a and click **Find Traces**\n\n![jaeger-trace](../../images/ocp-jaeger-traces.png)\n\n\n3. Click on one of the traces and expand the spans in the trace\n\n![jaeger-span](../../images/ocp-jaeger-spans.png)\n\n\nCheck one of the labs [Lab Jaeger - Node.js](./lab1) or [Lab Jaeger - Java](./lab2) for a more in depth lab for Opentracing with Jaeger.","frontmatter":{"title":"Using Jaeger in OpenShift/Kubernetes"},"fileAbsolutePath":"/home/travis/build/ibm-cloud-architecture/learning-cloudnative-101/src/pages/electives/dist-trace/activities/lab4/index.mdx"}}},"staticQueryHashes":["1364590287","2102389209","2102389209","2456312558","2746626797","2746626797","3018647132","3018647132","3037994772","3037994772","63531786","63531786","768070550"]}