{"componentChunkName":"component---src-pages-lectures-containers-activities-ibmcloud-cr-index-mdx","path":"/lectures/containers/activities/ibmcloud-cr/","result":{"pageContext":{"frontmatter":{"title":"Lab - IBM Cloud Container Registry","description":"Lab - IBM Cloud Container Registry"},"relativePagePath":"/lectures/containers/activities/ibmcloud-cr/index.mdx","titleType":"page","MdxNode":{"id":"b0de6ad4-c697-5006-8dc8-935b26927bda","children":[],"parent":"b03800e5-0214-5a68-9ea8-a0bd96767bd9","internal":{"content":"---\ntitle: Lab - IBM Cloud Container Registry\ndescription: Lab - IBM Cloud Container Registry\n---\n\nIn this lab we are going to create a Container Image and store it in the [IBM Cloud Container Registry](https://cloud.ibm.com/docs/Registry?topic=Registry-registry_overview)\n\n### Prerequisites\n- IBM Cloud Account\n\n### Login into IBM Cloud\n\n#### Using the IBM Cloud Shell\n\n1. Login into [IBM Cloud](https://cloud.ibm.com/)\n1. Select correct account from top right drop down if your IBM id is associated with multiple accounts\n1. Click the IBM Cloud Shell Icon on the top right corner of the IBM Cloud Console\n    ![ibm cloud shell icon](./images/ibmcloud-shell-button.png)\n1. This opens a new browser window with command linux terminal prompt.\n    ![ibm cloud shell prompt](./images/ibmcloud-shell-prompt.png)\n\n\n### Create a new Container Registry namespace\n\n1. Ensure that you're targeting the correct IBM Cloud Container Registry region. For example for Dallas region use **us-south**\n    ```\n    ibmcloud cr region-set us-south\n    ```\n1. Choose a name for your first namespace, and create that namespace. Use this namespace for the rest of the Quick Start.Create a new Container Registry Namespace. This namespace is different from a Kubernetes/OpenShift namespace. The name needs to be all lowercase  and globaly unique within a region.\n    ```\n    ibmcloud cr namespace-add <my_namespace>\n    ```\n    Now set the environment `NAMESPACE` to be use for the rest of the lab\n    ```\n    export NAMESPACE=<my_namespace>\n    ```\n\n### Building and Pusing a Container Image\n1. Clone the folowwing git repository and change directory to `1-containers`\n    ```\n    git clone --depth 1 https://github.com/csantanapr/think2020-nodejs.git my-app\n    cd my-app/1-containers/\n    ```\n1. Inspect the file `Dockerfile` it contains a multistage build, first layer builds the application, the second copies only the built files.\n    ```\n    cat Dockerfile\n    ```\n    ```Dockerfile\n    FROM registry.access.redhat.com/ubi8/nodejs-12 as base\n\n    FROM base as builder\n\n    WORKDIR /opt/app-root/src\n\n    COPY package*.json ./\n\n    RUN npm ci\n\n    COPY public public \n    COPY src src \n\n    RUN npm run build\n\n    FROM base\n\n    WORKDIR /opt/app-root/src\n\n    COPY --from=builder  /opt/app-root/src/build build\n\n    COPY package*.json ./\n\n    RUN npm ci --only=production\n\n    COPY --chown=1001:0 server server\n    RUN chmod -R g=u server\n\n    ENV PORT=8080\n\n    LABEL com.example.source=\"https://github.com/csantanapr/think2020-nodejs\"\n    LABEL com.example.version=\"1.0\"\n\n    ARG ENV=production\n    ENV NODE_ENV $ENV\n    ENV NODE_VERSION $NODEJS_VERSION\n    CMD npm run $NODE_ENV\n    ```\n1. Build and push the image, if not already set replace `$NAMESPACE` with the namespace you added previously, replace `us.icr.io` if using a different region.\n    ```\n    ibmcloud cr build --tag us.icr.io/$NAMESPACE/my-app:1.0 ./\n    ```\n\n### Explore the Container Registry on the IBM Cloud Console\n1. Explore the container image details using the IBM Cloud Console. Go to the Main Menu->Kubernetes->Registry you can use the tabs `Namespaces`, `Repository`, `Images`\n    ![cr namespace](./images/cr-namespaces.png)\n    ![cr namespace](./images/cr-repositories.png)\n    ![cr namespace](./images/cr-images.png)\n    ![cr namespace](./images/cr-settings.png)\n\n\n### Extra Credit (Run Imge on Kubernetes)\n\nIf you have a Kubernetes Cluster you can run your application image\n\n1. Get the Access token for your Kubernetes cluster, command assumes your cluster name is `mycluster`\n    ```\n    ibmcloud ks cluster config -c mycluster\n    ```\n1. Run the following commands to create a deployment using the image we just build. If not already set replace `$NAMESPACE` with your IBM Container Registry Namespace we stored the image.\n    ```\n    kubectl create deployment my-app --image us.icr.io/$NAMESPACE/my-app:1.0\n    kubectl rollout status deployment/my-app\n    kubectl port-forward deployment/my-app 8080:8080\n    ```\n    If the app is connected you should see the following output\n    ```\n    Forwarding from 127.0.0.1:8080 -> 8080\n    Forwarding from [::1]:8080 -> 8080\n    ```\n1. Open a new Session and run the following command\n    ```\n    curl localhost:8080 -I\n    ```\n    You should see in the first line of output the following\n    ```\n    HTTP/1.1 200 OK\n    ```\n1. To access the app using a browser use the IBM Cloud Shell Web Preview. Click the Web Preview Icon and select port `8080` from the drop down. The application will open in a new browser window.\n    ![ibm cloud shell web preview select](./images/ibmcloud-shell-preview.png)\n    ![web app](./images/web-app.png)\n\n1. To stop the application on the terminal with the `kubectl port-forward` command quit by pressing Ctrl+C in **Session 1*\n\n### Delete Deployment and Image\n\n1. Delete the app deployment\n    ```\n    kubectl delete deployment my-app\n    ```\n1. Delete the container image, if not already set replace `$NAMESPACE` with the registry namespace\n    ```\n    ibmcloud cr image-rm us.icr.io/$NAMESPACE/my-app:1.0\n    ```\n","type":"Mdx","contentDigest":"78f5eb40983fe390d7fedfa70f721846","counter":596,"owner":"gatsby-plugin-mdx"},"exports":[],"rawBody":"---\ntitle: Lab - IBM Cloud Container Registry\ndescription: Lab - IBM Cloud Container Registry\n---\n\nIn this lab we are going to create a Container Image and store it in the [IBM Cloud Container Registry](https://cloud.ibm.com/docs/Registry?topic=Registry-registry_overview)\n\n### Prerequisites\n- IBM Cloud Account\n\n### Login into IBM Cloud\n\n#### Using the IBM Cloud Shell\n\n1. Login into [IBM Cloud](https://cloud.ibm.com/)\n1. Select correct account from top right drop down if your IBM id is associated with multiple accounts\n1. Click the IBM Cloud Shell Icon on the top right corner of the IBM Cloud Console\n    ![ibm cloud shell icon](./images/ibmcloud-shell-button.png)\n1. This opens a new browser window with command linux terminal prompt.\n    ![ibm cloud shell prompt](./images/ibmcloud-shell-prompt.png)\n\n\n### Create a new Container Registry namespace\n\n1. Ensure that you're targeting the correct IBM Cloud Container Registry region. For example for Dallas region use **us-south**\n    ```\n    ibmcloud cr region-set us-south\n    ```\n1. Choose a name for your first namespace, and create that namespace. Use this namespace for the rest of the Quick Start.Create a new Container Registry Namespace. This namespace is different from a Kubernetes/OpenShift namespace. The name needs to be all lowercase  and globaly unique within a region.\n    ```\n    ibmcloud cr namespace-add <my_namespace>\n    ```\n    Now set the environment `NAMESPACE` to be use for the rest of the lab\n    ```\n    export NAMESPACE=<my_namespace>\n    ```\n\n### Building and Pusing a Container Image\n1. Clone the folowwing git repository and change directory to `1-containers`\n    ```\n    git clone --depth 1 https://github.com/csantanapr/think2020-nodejs.git my-app\n    cd my-app/1-containers/\n    ```\n1. Inspect the file `Dockerfile` it contains a multistage build, first layer builds the application, the second copies only the built files.\n    ```\n    cat Dockerfile\n    ```\n    ```Dockerfile\n    FROM registry.access.redhat.com/ubi8/nodejs-12 as base\n\n    FROM base as builder\n\n    WORKDIR /opt/app-root/src\n\n    COPY package*.json ./\n\n    RUN npm ci\n\n    COPY public public \n    COPY src src \n\n    RUN npm run build\n\n    FROM base\n\n    WORKDIR /opt/app-root/src\n\n    COPY --from=builder  /opt/app-root/src/build build\n\n    COPY package*.json ./\n\n    RUN npm ci --only=production\n\n    COPY --chown=1001:0 server server\n    RUN chmod -R g=u server\n\n    ENV PORT=8080\n\n    LABEL com.example.source=\"https://github.com/csantanapr/think2020-nodejs\"\n    LABEL com.example.version=\"1.0\"\n\n    ARG ENV=production\n    ENV NODE_ENV $ENV\n    ENV NODE_VERSION $NODEJS_VERSION\n    CMD npm run $NODE_ENV\n    ```\n1. Build and push the image, if not already set replace `$NAMESPACE` with the namespace you added previously, replace `us.icr.io` if using a different region.\n    ```\n    ibmcloud cr build --tag us.icr.io/$NAMESPACE/my-app:1.0 ./\n    ```\n\n### Explore the Container Registry on the IBM Cloud Console\n1. Explore the container image details using the IBM Cloud Console. Go to the Main Menu->Kubernetes->Registry you can use the tabs `Namespaces`, `Repository`, `Images`\n    ![cr namespace](./images/cr-namespaces.png)\n    ![cr namespace](./images/cr-repositories.png)\n    ![cr namespace](./images/cr-images.png)\n    ![cr namespace](./images/cr-settings.png)\n\n\n### Extra Credit (Run Imge on Kubernetes)\n\nIf you have a Kubernetes Cluster you can run your application image\n\n1. Get the Access token for your Kubernetes cluster, command assumes your cluster name is `mycluster`\n    ```\n    ibmcloud ks cluster config -c mycluster\n    ```\n1. Run the following commands to create a deployment using the image we just build. If not already set replace `$NAMESPACE` with your IBM Container Registry Namespace we stored the image.\n    ```\n    kubectl create deployment my-app --image us.icr.io/$NAMESPACE/my-app:1.0\n    kubectl rollout status deployment/my-app\n    kubectl port-forward deployment/my-app 8080:8080\n    ```\n    If the app is connected you should see the following output\n    ```\n    Forwarding from 127.0.0.1:8080 -> 8080\n    Forwarding from [::1]:8080 -> 8080\n    ```\n1. Open a new Session and run the following command\n    ```\n    curl localhost:8080 -I\n    ```\n    You should see in the first line of output the following\n    ```\n    HTTP/1.1 200 OK\n    ```\n1. To access the app using a browser use the IBM Cloud Shell Web Preview. Click the Web Preview Icon and select port `8080` from the drop down. The application will open in a new browser window.\n    ![ibm cloud shell web preview select](./images/ibmcloud-shell-preview.png)\n    ![web app](./images/web-app.png)\n\n1. To stop the application on the terminal with the `kubectl port-forward` command quit by pressing Ctrl+C in **Session 1*\n\n### Delete Deployment and Image\n\n1. Delete the app deployment\n    ```\n    kubectl delete deployment my-app\n    ```\n1. Delete the container image, if not already set replace `$NAMESPACE` with the registry namespace\n    ```\n    ibmcloud cr image-rm us.icr.io/$NAMESPACE/my-app:1.0\n    ```\n","frontmatter":{"title":"Lab - IBM Cloud Container Registry","description":"Lab - IBM Cloud Container Registry"},"fileAbsolutePath":"/home/travis/build/ibm-cloud-architecture/learning-cloudnative-101/src/pages/lectures/containers/activities/ibmcloud-cr/index.mdx"}}},"staticQueryHashes":["1364590287","2102389209","2102389209","2456312558","2746626797","2746626797","3018647132","3018647132","3037994772","3037994772","63531786","63531786","768070550"]}