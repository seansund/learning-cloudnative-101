(window.webpackJsonp=window.webpackJsonp||[]).push([[55],{p7lZ:function(e,t,a){"use strict";a.r(t),a.d(t,"_frontmatter",(function(){return l})),a.d(t,"default",(function(){return i}));var n=a("wx14"),r=a("zLVn"),o=(a("q1tI"),a("7ljp")),c=a("013z"),l=(a("qKvR"),{}),s={_frontmatter:l},p=c.a;function i(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(o.b)(p,Object(n.a)({},s,a,{components:t,mdxType:"MDXLayout"}),Object(o.b)("h3",null,"Prerequisite"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Configure the LogDNA Agent on a kubernetes cluster, you can use one of the labs in this bootcamp located ",Object(o.b)("a",Object(n.a)({parentName:"li"},{href:"/monitoring/logdna/#activities"}),"here"))),Object(o.b)("h2",null,"Logging library in Node.js"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"There are multiple logging libraries available for Node.js, on this example we are going to use ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://www.npmjs.com/package/pino"}),"pino"))),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"You can instrument a Node.js express web server using ",Object(o.b)("inlineCode",{parentName:"p"},"pino-http")," the example is located in GitHub ",Object(o.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/ibm-cloud-architecture/learning-cloudnative-101/blob/master/examples/logging/nodejs/app.js"}),"app.js")))),Object(o.b)("pre",null,Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-javascript"}),"const express = require('express')\nconst isProduction = process.env.NODE_ENV === 'production'\nconst formatters = {\n    level(label, number) {\n        return { level: label }\n    }\n}\nconst pino = require('pino-http')({\n    prettyPrint: isProduction ? false : true,\n    level: isProduction ? 'error' : 'info',\n    formatters: formatters,\n    messageKey: 'message'\n})\nconst PORT = process.env.PORT || 8080;\n\nvar app = express()\n\napp.use(pino)\n\napp.get('/', function (req, res) {\n    req.log.info('this is a info log message')\n    res.send('Hello World')\n})\napp.get('/error', function (req, res, next) {\n    req.log.error('Internal error with request /error')\n    res.status(503).send('Internal error')\n})\n\napp.listen(PORT, () => {\n    console.log(`Listening on PORT=${PORT} and isProduction=${isProduction}`);\n})\n")),Object(o.b)("h2",null,"Deploy the sample application"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Create a namespace",Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"kubectl create deployment my-app --image=ibmcase/nodejs-logging-example\n")))),Object(o.b)("h2",null,"Test the application"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Expose application web service on local port 8080"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),"kubectl port-forward deployment/my-app 8080:8080\n"))),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Send http request to the web service"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),'while true; do sleep 1; curl http://localhost:8080/error -s -w "\\n"; done\n')),Object(o.b)("p",{parentName:"li"},"  Output looks like this"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(n.a)({parentName:"pre"},{}),"Internal error\n"))),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Get the logs"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-bash"}),"kubectl logs deployment/my-app -f\n"))),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"The error line printend is JSON"),Object(o.b)("pre",{parentName:"li"},Object(o.b)("code",Object(n.a)({parentName:"pre"},{className:"language-json"}),'{"level":"error","time":1591588923197,"pid":25,"hostname":"my-app-78647889d5-nv4rt","req":{"id":2,"method":"GET","url":"/error","headers":{"host":"localhost:8080","user-agent":"curl/7.64.1","accept":"*/*"},"remoteAddress":"::ffff:127.0.0.1","remotePort":48458},"message":"Internal error with request /error"}\n')))),Object(o.b)("h2",null,"Find the JSON logs in LogDNA"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Open the Views"),Object(o.b)("li",{parentName:"ul"},"Search for ",Object(o.b)("inlineCode",{parentName:"li"},"container:nodejs-logging-example"))),Object(o.b)("span",{className:"gatsby-resp-image-wrapper",style:{position:"relative",display:"block",marginLeft:"auto",marginRight:"auto",maxWidth:"1152px"}},"\n      ",Object(o.b)("span",Object(n.a)({parentName:"span"},{className:"gatsby-resp-image-background-image",style:{paddingBottom:"54.513888888888886%",position:"relative",bottom:"0",left:"0",backgroundImage:"url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABfElEQVQoz42SWU7DMBCGfQnEVjuJ4y0hix23pU6A0FAkyiIqBAX1hSeEuALPIHEKzsokgAQFJD6NJWfsGc/MHySlzJLEZarWkUkTkVpjR8+X82o4yHWudS6k6HVg3FsCCcFOLqZD50pXVmVljLG2b01hrTWmiKIYY+z9ASoS/ng3ybYkpPZ9D3/Pj8mfkW3wxtp6M61uHq4YZx7x/MCHFO/2A7L0iVZWN48b8/qyODpvVASoH5d+hxCC4GLCvMm4uH+677u+4Nzz/xMLpflIhf6BVVwqFUnoF3eQD/Cnka6cztWOnYC1wdDjdeOKLIklT/Ug1iMVbzERQfetBcH7BkaOCSQImORMhDAaGlIUUDq7nbvagabbu266OBuUw3o61rbQ1ugCpDNwtH86Ppgdpnme9fMoUTBd0BgxGo6G27gtpxUmFBQeCKhP8Bd6OGABZRSq3gDWYW2CF5XVTpamO+Wg3hs1tYNnwpABvAM2cRyDBvAj8s6nlAo7oOc3MGdlMNmTkX8AAAAASUVORK5CYII=')",backgroundSize:"cover",display:"block"}})),"\n  ",Object(o.b)("img",Object(n.a)({parentName:"span"},{className:"gatsby-resp-image-image",alt:"json-logs-nodejs",title:"json-logs-nodejs",src:"/static/59c01581470828c33cfc5a842b84c0cc/3cbba/json-logs-nodejs.png",srcSet:["/static/59c01581470828c33cfc5a842b84c0cc/7fc1e/json-logs-nodejs.png 288w","/static/59c01581470828c33cfc5a842b84c0cc/a5df1/json-logs-nodejs.png 576w","/static/59c01581470828c33cfc5a842b84c0cc/3cbba/json-logs-nodejs.png 1152w","/static/59c01581470828c33cfc5a842b84c0cc/92c65/json-logs-nodejs.png 1216w"],sizes:"(max-width: 1152px) 100vw, 1152px",style:{width:"100%",height:"100%",margin:"0",verticalAlign:"middle",position:"absolute",top:"0",left:"0"},loading:"lazy"})),"\n    "))}i.isMDXComponent=!0}}]);
//# sourceMappingURL=component---src-pages-electives-logging-logdna-activities-logger-nodejs-mdx-553ffd5e3defc75800be.js.map